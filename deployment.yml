---
- name: Copy app, build Docker image and run container
  hosts: all
  become: true

  vars:
    remote_app_dir: /home/ec2-user            # where files land on remote host
    image_name: myapp                         # image: myapp:latest
    image_tag: latest
    container_name: myapp
    published_ports:
      - "5001:5001"                           # change as needed

  tasks:
    - name: Ensure remote directory exists
      ansible.builtin.file:
        path: "{{ remote_app_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy application files and Dockerfile to remote host
      ansible.builtin.copy:
        src: /home/ec2-user/ansible-poc-9/    # local folder containing Dockerfile + app
        dest: "{{ remote_app_dir }}/"
        owner: root
        group: root
        mode: "0644"
        directory_mode: "0755"

    # If your Dockerfile has a different name, set build.dockerfile accordingly.

    - name: Build Docker image on remote host
      community.docker.docker_image:
        name: "{{ image_name }}"
        tag: "{{ image_tag }}"
        source: build
        build:
          path: "{{ remote_app_dir }}/ansible-poc-9"   # directory with Dockerfile on remote
          dockerfile: Dockerfile
        state: present

    - name: Ensure container is running
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}:{{ image_tag }}"
        state: started
        restart_policy: always
        recreate: true
        ports: "{{ published_ports }}"
        detach: true
